<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toooko</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    header { margin-bottom: 20px; }
    h1 { font-size: 22px; margin: 0 0 5px 0; }
    .small { font-size: 12px; color: #555; }
    #grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .produk {
      border: 1px solid #ccc;
      padding: 10px;
      width: 220px;
      box-sizing: border-box;
    }
    .img-wrapper {
      width: 100%;
      height: 130px;
      background: #eee; /* skeleton abu-abu */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .img-wrapper img {
      width: 100%;
      height: auto;
      display: none; /* sembunyikan dulu */
    }
    .img-wrapper img.loaded {
      display: block; /* tampil setelah selesai dimuat */
    }
    .produk strong { display: block; font-size: 16px; margin-bottom: 5px; }
    .price { font-weight: bold; margin-bottom: 8px; }
    .beli { background: gray; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    dialog { border: 1px solid #ccc; padding: 10px; max-width: 320px; }
    dialog label { display: block; margin: 8px 0; font-size: 14px; }
    dialog input { width: 100%; padding: 5px; margin-top: 3px; }
    dialog .ft { margin-top: 10px; text-align: right; }
    dialog button { margin-left: 5px; padding: 5px 10px; }
  </style>
</head>
<body>
  <header>
    <h1>Toko Digital</h1>
    <div class="small">
      <s>loe jual gue beli</s> gw jual loe beli
    </div>
  </header>

  <main>
    <div id="grid"></div>
  </main>

  <footer class="small" style="margin-top:20px;">
    Â© <span id="y"></span> foter 
  </footer>

  <dialog id="checkout">
    <form method="dialog" id="coForm" onsubmit="return false;">
      <h3>Checkout</h3>
      <input type="hidden" name="productId" id="productId">
      <label>Nama Lengkap
        <input required name="name" id="name">
      </label>
      <label>Email
        <input required type="email" name="email" id="email">
      </label>
      <label>No. HP (opsional)
        <input name="phone" id="phone">
      </label>
      <div class="small">Setelah klik Bayar, Anda akan diarahkan ke halaman pembayaran Duitku.</div>
      <div class="ft">
        <button type="button" onclick="checkout.close()">Batal</button>
        <button class="beli" id="payBtn" type="submit">Bayar</button>
      </div>
    </form>
  </dialog>

  <script>
    const grid = document.getElementById('grid');
    const checkout = document.getElementById('checkout');
    const coForm = document.getElementById('coForm');
    const y = document.getElementById('y'); 
    y.textContent = new Date().getFullYear();
    let products = [];

    async function loadProducts() {
      const res = await fetch('../products.json');
      products = await res.json();
      grid.innerHTML = products.map(p => `
        <div class="produk">
          <div class="img-wrapper">
            <img src="${p.cover}" alt="${p.name}" onload="this.classList.add('loaded')">
          </div>
          <strong>${p.name}</strong>
          <div class="price">Rp ${p.price.toLocaleString('id-ID')}</div>
          <button class="beli" onclick="openCheckout('${p.id}')">Beli</button>
        </div>
      `).join('');
    }

    function openCheckout(id) {
      document.getElementById('productId').value = id;
      checkout.showModal();
    }

    coForm.addEventListener('submit', async e => {
      e.preventDefault();
      document.getElementById('payBtn').disabled = true;
      const formData = new FormData(coForm);
      const res = await fetch('../api/create_invoice.php', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      if (data.paymentUrl) {
        window.location.href = data.paymentUrl;
      } else {
        alert('Gagal membuat invoice');
      }
      document.getElementById('payBtn').disabled = false;
    });

    loadProducts();
  </script>

</body>
</html>
